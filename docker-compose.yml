version: '3'

volumes:
  mysql_data:
      driver: local

services:
  nginx:
        build:
            context: ./nginx
        container_name: "af2_nginx"
        ports:
            - "80:80"
            - "443:443"
        volumes:
            - ./volumes/log/nginx:/var/log/nginx
            - ./volumes/www:/var/www
            - ./volumes/certbot/conf:/etc/letsencrypt
            - ./volumes/certbot:/var/certbot
        links:
            - assets
            - clients
            - mesh
        #command: "/bin/sh -c 'while :; do sleep 6h & wait $${!}; nginx -s reload; done & nginx -g \"daemon off;\"'"
  certbot:
    image: certbot/certbot
    container_name: "af2_certbot"
    volumes:
      - ./volumes/certbot/conf:/etc/letsencrypt
      - ./volumes/certbot/www:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
  mysql:
      image: mysql:5.7
      container_name: "af2_mysql"
      volumes:
        - mysql_data:/var/lib/mysql
      environment:
        MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
        MYSQL_DATABASE: ${MYSQL_DATABASE}
        MYSQL_USER: ${MYSQL_USER}
        MYSQL_PASSWORD: ${MYSQL_PASSWORD}
  keycloak:
      image: quay.io/keycloak/keycloak:7.0.0
      container_name: "af2_keycloak"
      ports:
        - "8189:8080"
      environment:
        DB_VENDOR: ${DB_VENDOR}
        DB_ADDR: ${DB_ADDR}
        DB_DATABASE: ${DB_DATABASE}
        DB_USER: ${DB_USER}
        DB_PASSWORD: ${DB_PASSWORD}
        KEYCLOAK_USER: ${KEYCLOAK_USER}
        KEYCLOAK_PASSWORD: ${KEYCLOAK_PASSWORD}
        # Uncomment the line below if you want to specify JDBC parameters. The parameter below is just an example, and it shouldn't be used in production without knowledge. It is highly recommended that you read the MySQL JDBC driver documentation in order to use it.
        JDBC_PARAMS: "useSSL=false&connectTimeout=30000"
      ports:
        - 8080:8080
      depends_on:
        - mysql
  mongodb:
        image: mongo:latest
        container_name: "af2_mongodb"
        environment:
          - MONGO_DATA_DIR=/data/db
          - MONGO_LOG_DIR=/dev/null
        volumes:
          - ./volumes/data/db:/data/db
        ports:
            - 27017:27017
        command: mongod --bind_ip_all --logpath=/dev/null
  assets:
        build:
            context: ../ms-assets
        container_name: "af2_assets"
        environment:
            - spring.profiles.active=${spring_profiles_active}
            - JAVA_OPTS=-Xm2g -Xms2g
        ports:
            - "8100:8100"
            - "8191:8080"
        links:
            - mongodb
  clients:
        build:
            context: ../ms-clients
        container_name: "af2_clients"
        environment:
            - spring.profiles.active=${spring_profiles_active}
            - JAVA_OPTS=-Xm2g -Xms2g
        ports:
            - "8102:8102"
            - "8193:8080"
        links:
            - mongodb
  mesh:
        build:
            context: ../ms-mesh
        container_name: "af2_mesh"
        environment:
            - spring.profiles.active=${spring_profiles_active}
            - JAVA_OPTS=-Xm2g -Xms2g
        ports:
            - "8104:8104"
            - "8195:8080"
        links:
            - mongodb
